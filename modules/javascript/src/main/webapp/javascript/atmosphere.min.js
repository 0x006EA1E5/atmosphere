/*
 * Atmosphere.js
 * https://github.com/Atmosphere/atmosphere
 * 
 * Requires Portal 1.0
 * https://github.com/flowersinthesand/portal
 * 
 * Copyright 2012-2013, Donghwan Kim 
 * Licensed under the Apache License, Version 2.0
 * http://www.apache.org/licenses/LICENSE-2.0
 */
(function(){function k(a,c){var d,g,f=c.headers||{};if(c.readResponsesHeaders)for(d in c.lastTimestamp=(a.getResponseHeader("X-Cache-Date")||"").split(" ").pop(),c.uuid=(a.getResponseHeader("X-Atmosphere-tracking-id")||"").split(" ").pop(),f)(g=a.getResponseHeader(d))&&(f[d]=g)}function l(a,c){var d,g,f=c.headers||{};c.dropAtmosphereHeaders||(a.setRequestHeader("X-Atmosphere-Framework",m),a.setRequestHeader("X-Atmosphere-Transport",c.transport),a.setRequestHeader("X-Cache-Date",c.lastTimestamp||0), c.trackMessageLength&&a.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),c.contentType&&a.setRequestHeader("Content-Type",c.contentType),a.setRequestHeader("X-Atmosphere-tracking-id",c.uuid));for(d in f)g=f[d],(g=portal.support.isFunction(g)?g.call(null,a,c):g)&&a.setRequestHeader(d,g)}var m="1.1",j={},p=portal.support.now();j.subscribe=function(a){a=new j.AtmosphereRequest(a);a.open();return a};j.unsubscribe=portal.finalize;j.AtmosphereRequest=function(a){var c,d;a=portal.support.extend({url:"", connectTimeout:-1,reconnectInterval:0,timeout:3E5,method:"GET",fallbackMethod:"GET",headers:{},maxRequest:60,transport:"long-polling",fallbackTransport:"streaming",webSocketUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",shared:!1,lastTimestamp:0,readResponsesHeaders:!0,dropAtmosphereHeaders:!0,contentType:"",uuid:0,executeCallbackBeforeReconnect:!1},a);this.open=function(){function g(){f(); n=setTimeout(function(){c.fire("close","idletimeout")},a.timeout)}function f(){clearTimeout(n)}function h(a){return{"long-polling":"longpoll",streaming:"stream",jsonp:"longpolljsonp",sse:"sse",websocket:"ws",session:"session",test:"test"}[a]}var n;c=portal.open(a.url,{atrequest:a,method:a.method,transports:[h(a.transport)],timeout:a.connectTimeout,credentials:a.withCredentials,sharing:a.shared,params:a.headers,longpollTest:!1,urlBuilder:function(e,b){if(!a.attachHeadersAsQueryString)return e;delete b.id; delete b.transport;delete b.heartbeat;delete b.lastEventId;portal.support.extend(b,{"X-Atmosphere-tracking-id":a.uuid,"X-Atmosphere-Framework":m,"X-Atmosphere-Transport":a.transport,"X-Cache-Date":a.lastTimestamp||0});a.trackMessageLength&&(b["X-Atmosphere-TrackMessageSize"]=!0);a.contentType&&(b["Content-Type"]=a.contentType);return e+(/\?/.test(e)?"&":"?")+portal.support.param(b)},reconnect:function(e,b){return b<a.maxRequest?a.reconnectInterval:!1},xdrURL:a.enableXDR&&function(e){return(a.rewriteURL|| portal.defaults.xdrURL||function(){}).call(a.rewriteURL?window:c,e)||e},inbound:function(e){var b,d,f=[];0<a.timeout&&g();if(a.trackMessageLength){c.data("data")&&(e=c.data("data")+e);b=0;for(d=e.indexOf(a.messageDelimiter);-1!==d;){b=e.substring(b,d);e=e.substring(d+a.messageDelimiter.length,e.length);if(!e||e.length<b)break;d=e.indexOf(a.messageDelimiter);f.push(e.substring(0,b))}c.data("data",!f.length||-1!==d&&e&&b!==e.length?b+a.messageDelimiter+e:"")}else f.push(e);for(e=0;e<f.length;e++)f[e]= {type:"message",data:f[e]};return f},outbound:function(e){var b=a.webSocketUrl,d=a.webSocketPathDelimiter;0<a.timeout&&g();return("ws"===c.data("transport")&&b?d+b+d:"")+e.data},streamParser:function(a){return[a.replace(/^\s+/g,"")]},initIframe:function(a){var b;b=a.contentDocument||a.contentWindow.document;if(!b.body||!b.body.firstChild||"pre"!==b.body.firstChild.nodeName.toLowerCase())a=b.head||b.getElementsByTagName("head")[0]||b.documentElement||b,b=b.createElement("script"),b.text="document.write('<plaintext>')", a.insertBefore(b,a.firstChild),a.removeChild(b)}});c.on({connecting:function(){c.data("t1",{ws:"websocket",sse:"sse",streamxhr:"streaming",streamxdr:"streaming",streamiframe:"streaming",longpollajax:"long-polling",longpollxdr:"long-polling",longpolljsonp:"jsonp",session:"session",test:"test"}[c.data("transport")])},open:function(){var e={status:200,responseBody:"",headers:[],state:"messageReceived",transport:c.data("t1"),error:null,request:a};0<a.timeout&&(g(),c.one("close",f));if(d){if(e.state="re-opening", a.onReconnect)a.onReconnect(a,e)}else{e.state="opening";if(a.onOpen)a.onOpen(e);d=!0}a.callback&&a.callback(e)},message:function(e){var b={status:200,responseBody:e,headers:[],state:"messageReceived",transport:c.data("t1"),error:null,request:a};c.data("lastData",e);if(a.onMessage)a.onMessage(b);a.callback&&a.callback(b)},close:function(e){var b={status:200,responseBody:"",headers:[],state:"messageReceived",transport:c.data("t1"),error:null,request:a};switch(e){case "aborted":b.status=408;b.state= "unsubscribe";break;case "done":case "timeout":b.status=!d?501:200;b.state="closed";break;case "error":b.status=500;b.state="error";break;case "notransport":if(a.onTransportFailure)a.onTransportFailure(e,a);a.method=a.fallbackMethod;a.transport=a.fallbackTransport;c.option("method",a.method);c.option("transports",[h(a.transport)])}if("error"===e){if(a.onError)a.onError(b)}else if(a.onClose)a.onClose(b);a.callback&&a.callback(b);a.executeCallbackBeforeReconnect&&(c.fire("message",c.data("lastData")), c.option("method",a.method),c.option("transports",[h(a.transport)]))},waiting:function(){a.executeCallbackBeforeReconnect||c.fire("message",c.data("lastData"))},session:function(e){if(e.from!==c.option("id")&&a.onLocalMessage)a.onLocalMessage(e.message)}})};this.push=function(a){c.send("message",a)};this.pushLocal=function(a){c.broadcast("session",{from:c.option("id"),data:a})}};portal.support.extend(portal.transports,{httpbase:function(a,c){function d(){h.length?g(c.url,h.shift()):f=!1}var g,f,h= [];g=!c.crossDomain||portal.support.corsable?function(a,e){var b=portal.support.xhr();b.onreadystatechange=function(){4===b.readyState&&(k(b,c.atrequest),d())};b.open("POST",a);l(b,c.atrequest);portal.support.corsable&&(b.withCredentials=c.credentials);b.send(e)}:window.XDomainRequest&&c.xdrURL&&c.xdrURL.call(a,"t")?function(f,e){var b=new window.XDomainRequest;b.onload=b.onerror=d;b.open("POST",c.xdrURL.call(a,f));b.send(e)}:function(a,c){var b=document.createElement("form");b.action=a;b.target= "socket-"+ ++p;b.method="POST";b.enctype=b.encoding="text/plain";b.acceptCharset="UTF-8";b.style.display="none";b.innerHTML='<textarea name="data"></textarea><iframe name="'+b.target+'"></iframe>';b.firstChild.value=c;portal.support.on(b.lastChild,"load",function(){document.body.removeChild(b);d()});document.body.appendChild(b);b.submit()};return{send:function(a){h.push(a);f||(f=!0,d())}}},streamxhr:function(a,c){var d;if(!(portal.support.browser.msie&&10>+portal.support.browser.version||c.crossDomain&& !portal.support.corsable))return portal.support.extend(portal.transports.httpbase(a,c),{open:function(){var g;d=portal.support.xhr();d.onreadystatechange=function(){function f(){var c=a.data("index"),f=d.responseText.length;c?f>c&&a._fire(d.responseText.substring(c,f),!0):a.fire("open")._fire(d.responseText,!0);a.data("index",f)}2===d.readyState?k(d,c.atrequest):3===d.readyState&&200===d.status?portal.support.browser.opera&&!g?g=portal.support.iterate(f):f():4===d.readyState&&(g&&g(),a.fire("close", 200===d.status?"done":"error"))};d.open("GET",a.data("url"));portal.support.corsable&&(d.withCredentials=c.credentials);l(d,c.atrequest);d.send(null)},close:function(){d.abort()}})},longpollajax:function(a,c){var d,g,f=0;if(!c.crossDomain||portal.support.corsable)return portal.support.extend(portal.transports.httpbase(a,c),{open:function(){function h(){var j=a.buildURL({count:++f});a.data("url",j);d=portal.support.xhr();d.onreadystatechange=function(){var e;!g&&4===d.readyState&&(200===d.status?(k(d, c.atrequest),(e=d.responseText)||1===f?(1===f&&a.fire("open"),e&&a._fire(e),h()):a.fire("close","done")):a.fire("close","error"))};d.open("GET",j);l(d,c.atrequest);portal.support.corsable&&(d.withCredentials=c.credentials);d.send(null)}c.longpollTest?h():setTimeout(function(){a.fire("open");h()},50)},close:function(){g=!0;d.abort()}})}});portal.support.on(window,"keypress",function(a){27===a.which&&a.preventDefault()});window.atmosphere=j})();