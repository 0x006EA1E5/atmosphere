<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>Guice DI Test</title>
    <style type="text/css">
        body {
            background-color: #f5f5f5;
        }

        fieldset {
            border-style: inset;
            width: 460px;
        }

        fieldset input {
            width: 300px;
        }
    </style>
    <script type="text/javascript" src="jquery-1.4.3.js"></script>
    <script type="text/javascript" src="jquery.atmosphere.js"></script>
    <script type="text/javascript">
        $(function() {

            $.atmosphere.logLevel = 'info';

            var nickname = 'Anonymous';

            $('#changeNickname').click(function(e) {
                e.preventDefault();
                var n = prompt('Enter your nickname:', '');
                if (n) $('#nickname').text(nickname = n);
            });

            $('#listen').click(function(e) {
                e.preventDefault();
                var topicName = prompt("Enter the topic name:", "");
                if (topicName) {
                    if ($('#content fieldset#' + topicName).length == 0) {

                        var connected = false;
                        $.atmosphere.subscribe('async/topic/' + topicName, function(response) {
                            console.log(response);
                            if (response.transport != 'polling' && response.state != 'connected' && response.state != 'closed' && response.status == 200) {
                                var data = response.responseBody;
                                var pos = data.indexOf('<!-- EOD -->');
                                if(pos != -1) data = data.substring(pos + 12);
                                if (pos != -1) {

                                    // setup UI
                                    if(!connected) {

                                        $('<fieldset id="' + topicName + '"><legend>' + topicName + '</legend><input type="text"><button type="button" class="send">Send</button><button type="button" class="close">Disconnect</button><div class="messages"></div></fieldset>').appendTo($('#content'));

                                        $('#content fieldset#' + topicName + ' button.send').data('endpoint', endpoint).click(function() {
                                            var message = $('#content fieldset#' + topicName + ' input').val();
                                            $('#content fieldset#' + topicName + ' input').val('');
                                            $.atmosphere.request = {method: 'POST', callback: null, data: 'message=' + encodeURIComponent(nickname + " : " + message)};
                                            $(this).data('endpoint').push('async/topic/' + topicName, null, $.atmosphere.request);
                                        });

                                        $('#content fieldset#' + topicName + ' button.close').data('endpoint', endpoint).click(function() {
                                            $.atmosphere.request = {method: 'POST', callback: null};
                                            $(this).data('endpoint').push('async/topic/close/' + topicName, null, $.atmosphere.request);
                                            $.atmosphere.closeSuspendedConnection();
                                            $('#content fieldset#' + topicName).remove();
                                        });

                                        connected = true;
                                    }

                                    $('#content fieldset#' + topicName + ' .messages').html('<pre>' + data + '</pre>');
                                }
                            }
                        }, $.atmosphere.request = {transport: 'autodetect'});

                        var endpoint = $.atmosphere.response;
                    }
                }
            });

        });
    </script>
</head>
<body>
<div>
    Nickname: <span id="nickname">Anonymous</span> (<a id="changeNickname" href="#">change</a>)
</div>
<div>
    <a id="listen" href="#">Listen to a topic...</a>
</div>
<div id="content"></div>
</body>
</html>
